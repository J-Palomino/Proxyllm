# Base image for building - using official Python 3.12 slim for package compatibility
ARG LITELLM_BUILD_IMAGE=python:3.12-slim-bookworm

# Runtime image
ARG LITELLM_RUNTIME_IMAGE=python:3.12-slim-bookworm
# Builder stage
FROM $LITELLM_BUILD_IMAGE AS builder

# Set the working directory to /app
WORKDIR /app

# Install build dependencies (Debian-based) - unset Railway proxy vars inline
RUN unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy && \
    apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    libssl-dev \
    libffi-dev \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Create a wrapper script to clear proxy vars (Railway injects them at build time)
RUN echo '#!/bin/sh' > /usr/local/bin/noproxy && \
    echo 'unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy' >> /usr/local/bin/noproxy && \
    echo 'exec "$@"' >> /usr/local/bin/noproxy && \
    chmod +x /usr/local/bin/noproxy

# Use wrapper for pip commands
RUN /usr/local/bin/noproxy pip install --upgrade pip && \
    /usr/local/bin/noproxy pip install build

# Copy requirements first for better layer caching
COPY requirements.txt pyproject.toml ./

# Install dependencies as wheels BEFORE copying source (better caching)
RUN /usr/local/bin/noproxy pip wheel --wheel-dir=/wheels/ -r requirements.txt

# Now copy the rest of the source code
COPY . .

# Build the package (use noproxy to avoid Railway's proxy vars breaking pip in build isolation)
RUN rm -rf dist/* && /usr/local/bin/noproxy python -m build

# There should be only one wheel file now, assume the build only creates one
RUN ls -1 dist/*.whl | head -1

# Install the package
RUN /usr/local/bin/noproxy pip install dist/*.whl

# ensure pyjwt is used, not jwt
RUN /usr/local/bin/noproxy pip uninstall jwt -y || true
RUN /usr/local/bin/noproxy pip uninstall PyJWT -y || true
RUN /usr/local/bin/noproxy pip install PyJWT==2.9.0 --no-cache-dir

# Build Admin UI
RUN chmod +x docker/build_admin_ui.sh && ./docker/build_admin_ui.sh

# Runtime stage
FROM $LITELLM_RUNTIME_IMAGE AS runtime

# Create wrapper script to clear proxy vars
RUN echo '#!/bin/sh' > /usr/local/bin/noproxy && \
    echo 'unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy' >> /usr/local/bin/noproxy && \
    echo 'exec "$@"' >> /usr/local/bin/noproxy && \
    chmod +x /usr/local/bin/noproxy

# Install runtime dependencies including Tailscale, Node.js (for prisma), and PostgreSQL
RUN unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy && \
    apt-get update && apt-get install -y --no-install-recommends \
    openssl \
    tzdata \
    curl \
    iptables \
    iproute2 \
    ca-certificates \
    wget \
    gnupg \
    postgresql \
    postgresql-contrib \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/*

# Setup PostgreSQL data directory and permissions
RUN mkdir -p /var/run/postgresql && \
    chown -R postgres:postgres /var/run/postgresql && \
    mkdir -p /var/lib/postgresql/data && \
    chown -R postgres:postgres /var/lib/postgresql

# Install Tailscale static binary
RUN /usr/local/bin/noproxy wget https://pkgs.tailscale.com/stable/tailscale_1.56.1_amd64.tgz && \
    tar xzf tailscale_1.56.1_amd64.tgz && \
    mv tailscale_1.56.1_amd64/tailscale /usr/bin/ && \
    mv tailscale_1.56.1_amd64/tailscaled /usr/sbin/ && \
    rm -rf tailscale_1.56.1_amd64 tailscale_1.56.1_amd64.tgz

WORKDIR /app
# Copy the current directory contents into the container at /app
COPY . .
RUN ls -la /app

# Copy the built wheel from the builder stage to the runtime stage; assumes only one wheel file is present
COPY --from=builder /app/dist/*.whl .
COPY --from=builder /wheels/ /wheels/

# Install the built wheel using pip; again using a wildcard if it's the only file
RUN /usr/local/bin/noproxy pip install *.whl /wheels/* --no-index --find-links=/wheels/ && rm -f *.whl && rm -rf /wheels

# Install semantic_router and aurelio-sdk using script
RUN chmod +x docker/install_auto_router.sh && /usr/local/bin/noproxy ./docker/install_auto_router.sh

# Generate prisma client (use noproxy to allow npm registry access)
RUN /usr/local/bin/noproxy prisma generate
RUN chmod +x docker/entrypoint.sh
RUN chmod +x docker/prod_entrypoint.sh

EXPOSE 4000/tcp

RUN unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy && \
    apt-get update && apt-get install -y --no-install-recommends supervisor proxychains4 && rm -rf /var/lib/apt/lists/*

# Configure proxychains4 to use Tailscale SOCKS5 proxy
RUN sed -i 's/socks4[[:space:]]\+127\.0\.0\.1[[:space:]]\+9050/socks5h 127.0.0.1 1055/' /etc/proxychains4.conf && \
    sed -i 's/^strict_chain/#strict_chain/' /etc/proxychains4.conf && \
    sed -i 's/^#dynamic_chain/dynamic_chain/' /etc/proxychains4.conf
COPY docker/supervisord.conf /etc/supervisord.conf

# Create startup script with PostgreSQL, Tailscale, and LiteLLM
# Note: No set -e so failures don't prevent LiteLLM from starting
# CRITICAL: Unset proxy vars at very start - Railway injects these at runtime
RUN echo '#!/bin/sh' > /app/start_with_tailscale.sh && \
    echo '# Clear Railway proxy vars immediately - they break Python HTTP clients' >> /app/start_with_tailscale.sh && \
    echo 'export HTTP_PROXY="" HTTPS_PROXY="" ALL_PROXY="" http_proxy="" https_proxy="" all_proxy="" NO_PROXY="*"' >> /app/start_with_tailscale.sh && \
    echo '' >> /app/start_with_tailscale.sh && \
    echo '# Start PostgreSQL' >> /app/start_with_tailscale.sh && \
    echo 'echo "Starting PostgreSQL..."' >> /app/start_with_tailscale.sh && \
    echo 'PGDATA=/var/lib/postgresql/data' >> /app/start_with_tailscale.sh && \
    echo 'if [ ! -f "$PGDATA/PG_VERSION" ]; then' >> /app/start_with_tailscale.sh && \
    echo '  echo "Initializing PostgreSQL database..."' >> /app/start_with_tailscale.sh && \
    echo '  su postgres -c "/usr/lib/postgresql/15/bin/initdb -D $PGDATA"' >> /app/start_with_tailscale.sh && \
    echo '  echo "host all all 0.0.0.0/0 md5" >> $PGDATA/pg_hba.conf' >> /app/start_with_tailscale.sh && \
    echo '  echo "listen_addresses = '"'"'*'"'"'" >> $PGDATA/postgresql.conf' >> /app/start_with_tailscale.sh && \
    echo 'fi' >> /app/start_with_tailscale.sh && \
    echo 'su postgres -c "/usr/lib/postgresql/15/bin/pg_ctl -D $PGDATA -l /var/lib/postgresql/logfile start"' >> /app/start_with_tailscale.sh && \
    echo 'sleep 3' >> /app/start_with_tailscale.sh && \
    echo '# Create litellm database and user if not exists' >> /app/start_with_tailscale.sh && \
    echo 'su postgres -c "psql -tc \"SELECT 1 FROM pg_database WHERE datname = '"'"'litellm'"'"'\" | grep -q 1 || psql -c \"CREATE DATABASE litellm;\""' >> /app/start_with_tailscale.sh && \
    echo 'su postgres -c "psql -tc \"SELECT 1 FROM pg_roles WHERE rolname = '"'"'litellm'"'"'\" | grep -q 1 || psql -c \"CREATE USER litellm WITH PASSWORD '"'"'litellm'"'"';\""' >> /app/start_with_tailscale.sh && \
    echo 'su postgres -c "psql -c \"GRANT ALL PRIVILEGES ON DATABASE litellm TO litellm;\""' >> /app/start_with_tailscale.sh && \
    echo 'su postgres -c "psql -d litellm -c \"GRANT ALL ON SCHEMA public TO litellm;\""' >> /app/start_with_tailscale.sh && \
    echo 'echo "PostgreSQL started and configured."' >> /app/start_with_tailscale.sh && \
    echo '' >> /app/start_with_tailscale.sh && \
    echo '# Set DATABASE_URL for local PostgreSQL if not already set to external' >> /app/start_with_tailscale.sh && \
    echo 'if [ -z "$DATABASE_URL" ] || echo "$DATABASE_URL" | grep -q "railway.internal"; then' >> /app/start_with_tailscale.sh && \
    echo '  export DATABASE_URL="postgresql://litellm:litellm@localhost:5432/litellm"' >> /app/start_with_tailscale.sh && \
    echo '  echo "Using local PostgreSQL: $DATABASE_URL"' >> /app/start_with_tailscale.sh && \
    echo 'fi' >> /app/start_with_tailscale.sh && \
    echo '' >> /app/start_with_tailscale.sh && \
    echo 'echo "Starting Tailscale daemon..."' >> /app/start_with_tailscale.sh && \
    echo 'tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &' >> /app/start_with_tailscale.sh && \
    echo 'sleep 3' >> /app/start_with_tailscale.sh && \
    echo 'if [ -n "$TAILSCALE_AUTH_KEY" ]; then' >> /app/start_with_tailscale.sh && \
    echo '  TAILSCALE_ROUTES="${TAILSCALE_ADVERTISE_ROUTES:-}"' >> /app/start_with_tailscale.sh && \
    echo '  TAILSCALE_ACCEPT_ROUTES="${TAILSCALE_ACCEPT_ROUTES:-true}"' >> /app/start_with_tailscale.sh && \
    echo '  if [ -n "$TAILSCALE_ROUTES" ]; then' >> /app/start_with_tailscale.sh && \
    echo '    echo "Connecting to Tailscale with subnet routes: $TAILSCALE_ROUTES"' >> /app/start_with_tailscale.sh && \
    echo '    tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=railway-litellm --advertise-routes=$TAILSCALE_ROUTES --accept-routes=$TAILSCALE_ACCEPT_ROUTES --accept-dns=false --timeout=30s || echo "Tailscale connection failed, continuing anyway"' >> /app/start_with_tailscale.sh && \
    echo '  else' >> /app/start_with_tailscale.sh && \
    echo '    echo "Connecting to Tailscale (no subnet routing)"' >> /app/start_with_tailscale.sh && \
    echo '    tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=railway-litellm --accept-routes=$TAILSCALE_ACCEPT_ROUTES --accept-dns=false --timeout=30s || echo "Tailscale connection failed, continuing anyway"' >> /app/start_with_tailscale.sh && \
    echo '  fi' >> /app/start_with_tailscale.sh && \
    echo '  echo "Tailscale status:"' >> /app/start_with_tailscale.sh && \
    echo '  tailscale status || true' >> /app/start_with_tailscale.sh && \
    echo '  echo "Tailscale connected - using proxychains4 for routing"' >> /app/start_with_tailscale.sh && \
    echo '  export USE_PROXYCHAINS=1' >> /app/start_with_tailscale.sh && \
    echo 'else' >> /app/start_with_tailscale.sh && \
    echo '  echo "WARNING: TAILSCALE_AUTH_KEY not set, skipping Tailscale connection"' >> /app/start_with_tailscale.sh && \
    echo '  export USE_PROXYCHAINS=0' >> /app/start_with_tailscale.sh && \
    echo 'fi' >> /app/start_with_tailscale.sh && \
    echo 'echo "Starting LiteLLM proxy..."' >> /app/start_with_tailscale.sh && \
    echo 'if [ "$USE_PROXYCHAINS" = "1" ]; then' >> /app/start_with_tailscale.sh && \
    echo '  exec proxychains4 -q docker/prod_entrypoint.sh "$@"' >> /app/start_with_tailscale.sh && \
    echo 'else' >> /app/start_with_tailscale.sh && \
    echo '  exec docker/prod_entrypoint.sh "$@"' >> /app/start_with_tailscale.sh && \
    echo 'fi' >> /app/start_with_tailscale.sh && \
    chmod +x /app/start_with_tailscale.sh

ENTRYPOINT ["/app/start_with_tailscale.sh"]

# Append "--detailed_debug" to the end of CMD to view detailed debug logs
CMD ["--config", "proxy_server_config.railway.yaml", "--port", "4000"]
