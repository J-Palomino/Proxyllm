# Base image for building - use Python 3.12 (3.14 is too new for many packages)
ARG LITELLM_BUILD_IMAGE=python:3.12-slim-bookworm

# Runtime image
ARG LITELLM_RUNTIME_IMAGE=python:3.12-slim-bookworm
# Builder stage
FROM $LITELLM_BUILD_IMAGE AS builder

# Set the working directory to /app
WORKDIR /app

USER root

# Install build dependencies
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    apt-get update && apt-get install -y --no-install-recommends \
    gcc g++ make libssl-dev libffi-dev python3-dev \
    && rm -rf /var/lib/apt/lists/*


# Clear proxy vars during build (Railway sets SOCKS proxy which pip can't use)
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    pip install --upgrade pip && \
    HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    pip install build

# Copy the current directory contents into the container at /app
COPY . .

# Build Admin UI
RUN chmod +x docker/build_admin_ui.sh && ./docker/build_admin_ui.sh

# Build the package (clear proxy vars for subprocesses)
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    python -m build

# There should be only one wheel file now, assume the build only creates one
RUN ls -1 dist/*.whl | head -1

# Install the package
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    pip install dist/*.whl

# install dependencies as wheels
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    pip wheel --no-cache-dir --wheel-dir=/wheels/ -r requirements.txt

# ensure pyjwt is used, not jwt
RUN pip uninstall jwt -y || true
RUN pip uninstall PyJWT -y || true
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    pip install PyJWT==2.9.0 --no-cache-dir

# Build Admin UI
RUN chmod +x docker/build_admin_ui.sh && ./docker/build_admin_ui.sh

# Runtime stage
FROM $LITELLM_RUNTIME_IMAGE AS runtime

# Ensure runtime stage runs as root
USER root

# Install runtime dependencies including Tailscale
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    apt-get update && apt-get install -y --no-install-recommends \
    openssl tzdata curl iptables iproute2 ca-certificates wget \
    && rm -rf /var/lib/apt/lists/*

# Install Tailscale static binary (compatible with Wolfi Linux)
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    wget https://pkgs.tailscale.com/stable/tailscale_1.56.1_amd64.tgz && \
    tar xzf tailscale_1.56.1_amd64.tgz && \
    mv tailscale_1.56.1_amd64/tailscale /usr/bin/ && \
    mv tailscale_1.56.1_amd64/tailscaled /usr/sbin/ && \
    rm -rf tailscale_1.56.1_amd64 tailscale_1.56.1_amd64.tgz

WORKDIR /app
# Copy the current directory contents into the container at /app
COPY . .
RUN ls -la /app

# Copy the built wheel from the builder stage to the runtime stage; assumes only one wheel file is present
COPY --from=builder /app/dist/*.whl .
COPY --from=builder /wheels/ /wheels/

# Install the built wheel using pip; again using a wildcard if it's the only file
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    pip install *.whl /wheels/* --no-index --find-links=/wheels/ && rm -f *.whl && rm -rf /wheels

# Install pproxy for HTTP-to-SOCKS proxy conversion (aiohttp doesn't natively support SOCKS5 via env vars)
RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    pip install pproxy

# Install semantic_router and aurelio-sdk using script
RUN chmod +x docker/install_auto_router.sh && ./docker/install_auto_router.sh

# Generate prisma client
RUN prisma generate
RUN chmod +x docker/entrypoint.sh
RUN chmod +x docker/prod_entrypoint.sh

EXPOSE 4000/tcp

RUN HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= http_proxy= https_proxy= all_proxy= \
    apt-get update && apt-get install -y --no-install-recommends supervisor && rm -rf /var/lib/apt/lists/*
COPY docker/supervisord.conf /etc/supervisord.conf

# Create Tailscale startup script with subnet routing support
RUN echo '#!/bin/sh' > /app/start_with_tailscale.sh && \
    echo 'set -e' >> /app/start_with_tailscale.sh && \
    echo 'echo "Starting Tailscale daemon..."' >> /app/start_with_tailscale.sh && \
    echo 'tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &' >> /app/start_with_tailscale.sh && \
    echo 'sleep 3' >> /app/start_with_tailscale.sh && \
    echo 'if [ -n "$TAILSCALE_AUTH_KEY" ]; then' >> /app/start_with_tailscale.sh && \
    echo '  TAILSCALE_ROUTES="${TAILSCALE_ADVERTISE_ROUTES:-}"' >> /app/start_with_tailscale.sh && \
    echo '  TAILSCALE_ACCEPT_ROUTES="${TAILSCALE_ACCEPT_ROUTES:-true}"' >> /app/start_with_tailscale.sh && \
    echo '  if [ -n "$TAILSCALE_ROUTES" ]; then' >> /app/start_with_tailscale.sh && \
    echo '    echo "Connecting to Tailscale with subnet routes: $TAILSCALE_ROUTES"' >> /app/start_with_tailscale.sh && \
    echo '    tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=railway-litellm --advertise-routes=$TAILSCALE_ROUTES --accept-routes=$TAILSCALE_ACCEPT_ROUTES --accept-dns=false' >> /app/start_with_tailscale.sh && \
    echo '  else' >> /app/start_with_tailscale.sh && \
    echo '    echo "Connecting to Tailscale (no subnet routing)"' >> /app/start_with_tailscale.sh && \
    echo '    tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=railway-litellm --accept-routes=$TAILSCALE_ACCEPT_ROUTES --accept-dns=false' >> /app/start_with_tailscale.sh && \
    echo '  fi' >> /app/start_with_tailscale.sh && \
    echo '  echo "Tailscale connected successfully!"' >> /app/start_with_tailscale.sh && \
    echo '  tailscale status' >> /app/start_with_tailscale.sh && \
    echo 'else' >> /app/start_with_tailscale.sh && \
    echo '  echo "WARNING: TAILSCALE_AUTH_KEY not set, skipping Tailscale connection"' >> /app/start_with_tailscale.sh && \
    echo 'fi' >> /app/start_with_tailscale.sh && \
    echo 'echo "Starting HTTP-to-SOCKS proxy bridge..."' >> /app/start_with_tailscale.sh && \
    echo 'pproxy -l http://0.0.0.0:1080 -r socks5://localhost:1055 &' >> /app/start_with_tailscale.sh && \
    echo 'sleep 1' >> /app/start_with_tailscale.sh && \
    echo 'export HTTP_PROXY=http://localhost:1080' >> /app/start_with_tailscale.sh && \
    echo 'export HTTPS_PROXY=http://localhost:1080' >> /app/start_with_tailscale.sh && \
    echo 'export http_proxy=http://localhost:1080' >> /app/start_with_tailscale.sh && \
    echo 'export https_proxy=http://localhost:1080' >> /app/start_with_tailscale.sh && \
    echo 'echo "Starting LiteLLM proxy..."' >> /app/start_with_tailscale.sh && \
    echo 'exec docker/prod_entrypoint.sh "$@"' >> /app/start_with_tailscale.sh && \
    chmod +x /app/start_with_tailscale.sh

ENTRYPOINT ["/app/start_with_tailscale.sh"]

# Append "--detailed_debug" to the end of CMD to view detailed debug logs
# Build trigger: pproxy v1
CMD ["--config", "proxy_server_config.railway.yaml", "--port", "4000"]
